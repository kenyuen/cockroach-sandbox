apiVersion: v1
kind: ConfigMap
metadata:
  name: cockroach-scripts
  labels:
    app: cockroach
    purpose: bootstrap
data:
  start-cockroach.sh: |-
    #!/usr/bin/env bash
    # GENERATED — review before use
    # Security rationale: compute locality deterministically and keep TLS/secure-mode TODOs centralized.
    set -euo pipefail

    POD_NAME=${POD_NAME:-}
    REGION=${REGION:-east}
    JOIN_HOSTS=${JOIN_HOSTS:-}
    HEADLESS_SERVICE=${HEADLESS_SERVICE:-cockroach}
    NAMESPACE=${NAMESPACE:-default}
    COCKROACH_BIN=${COCKROACH_BIN:-/cockroach/cockroach}
    COCKROACH_START_FLAGS=${COCKROACH_START_FLAGS:-"--cache=25% --max-sql-memory=25%"}
    CLUSTER_NAME=${CLUSTER_NAME:-local-cockroach}

    if [[ -z "${POD_NAME}" ]]; then
      echo "ERROR: POD_NAME is required" >&2
      exit 1
    fi

    if [[ -z "${JOIN_HOSTS}" ]]; then
      echo "ERROR: JOIN_HOSTS list is required" >&2
      exit 1
    fi

    if [[ ! -x "${COCKROACH_BIN}" ]]; then
      echo "ERROR: Cockroach binary not found at ${COCKROACH_BIN}" >&2
      exit 2
    fi

    ORDINAL=${POD_NAME##*-}
    if [[ ! "${ORDINAL}" =~ ^[0-9]+$ ]]; then
      echo "ERROR: Unable to derive ordinal from POD_NAME=${POD_NAME}" >&2
      exit 3
    fi

    if [[ "${REGION}" == "east" ]]; then
      DC_INDEX=$((ORDINAL + 1))
    else
      DC_INDEX=$((ORDINAL + 4))
    fi

    LOCALITY="region=${REGION},datacenter=dc${DC_INDEX}"
    ADVERTISE_HOST="${POD_NAME}.${HEADLESS_SERVICE}.${NAMESPACE}.svc.cluster.local"

    START_FLAGS=()
    if [[ -n "${COCKROACH_START_FLAGS}" ]]; then
      read -r -a START_FLAGS <<< "${COCKROACH_START_FLAGS}"
    fi

    CMD=(
      "${COCKROACH_BIN}"
      start
      --insecure
      "--join=${JOIN_HOSTS}"
      --listen-addr=0.0.0.0:26257
      --http-addr=0.0.0.0:8080
      "--advertise-addr=${ADVERTISE_HOST}:26257"
      "--locality=${LOCALITY}"
      "--cluster-name=${CLUSTER_NAME}"
    )

    if [[ ${#START_FLAGS[@]} -gt 0 ]]; then
      CMD+=("${START_FLAGS[@]}")
    fi

    echo "Starting CockroachDB at ${ADVERTISE_HOST} with locality ${LOCALITY} and join hosts ${JOIN_HOSTS}"
    exec "${CMD[@]}"

  init-cockroach.sh: |-
    #!/usr/bin/env bash
    # GENERATED — review before use
    # Keep this in sync with init/init-cockroach.sh for local developer parity. TODO: create a shared library for this logic.
    set -euo pipefail

    INIT_HOST=${INIT_HOST:-cockroach-east-0.cockroach-east:26257}
    RETRIES=${RETRIES:-30}
    SLEEP=${SLEEP:-2}
    COCKROACH_BIN=${COCKROACH_BIN:-/cockroach/cockroach}

    if [[ ! -x "${COCKROACH_BIN}" ]]; then
      echo "ERROR: Cockroach binary not found at ${COCKROACH_BIN}" >&2
      exit 2
    fi

    INIT_HOST_ONLY=${INIT_HOST%%:*}
    INIT_PORT=${INIT_HOST##*:}

    if [[ ! "${INIT_HOST}" =~ :[0-9]+$ ]]; then
      echo "ERROR: INIT_HOST must be in host:port form (got: ${INIT_HOST})" >&2
      exit 2
    fi

    echo "Waiting for CockroachDB node at ${INIT_HOST} to accept connections..."
    for i in $(seq 1 ${RETRIES}); do
      if bash -c "</dev/tcp/${INIT_HOST_ONLY}/${INIT_PORT}" >/dev/null 2>&1; then
        echo "TCP connection to ${INIT_HOST} accepted. Proceeding..."
        break
      fi

      if ${COCKROACH_BIN} node status --insecure --host=${INIT_HOST_ONLY}:${INIT_PORT} >/dev/null 2>&1; then
        echo "CockroachDB node status OK. Proceeding with init..."
        break
      fi

      if ${COCKROACH_BIN} sql --insecure --host=${INIT_HOST} --execute "SELECT 1;" >/dev/null 2>&1; then
        echo "CockroachDB SQL responded. Proceeding with init..."
        break
      fi

      echo "Attempt ${i}/${RETRIES}: not ready yet, sleeping ${SLEEP}s..."
      sleep ${SLEEP}

      if [[ ${i} -eq ${RETRIES} ]]; then
        echo "Timed out waiting for CockroachDB at ${INIT_HOST}" >&2
        exit 1
      fi
    done

    set +e
    ${COCKROACH_BIN} init --insecure --host=${INIT_HOST}
    RC=$?
    set -e
    if [[ ${RC} -eq 0 ]]; then
      echo "cockroach init succeeded"
    else
      echo "cockroach init exit code ${RC} (may already be initialized). Continuing..."
    fi

    ${COCKROACH_BIN} sql --insecure --host=${INIT_HOST} --execute "CREATE DATABASE IF NOT EXISTS movr;" || true
    ${COCKROACH_BIN} sql --insecure --host=${INIT_HOST} --execute "CREATE SCHEMA IF NOT EXISTS demo.app;" || true

    set +e
    ${COCKROACH_BIN} sql --insecure --host=${INIT_HOST} --execute "CREATE USER IF NOT EXISTS demo WITH PASSWORD 'demo';"
    RC=$?
    set -e
    if [[ ${RC} -ne 0 ]]; then
      echo "Creating user with password failed (likely insecure mode). Falling back to no-password user."
      ${COCKROACH_BIN} sql --insecure --host=${INIT_HOST} --execute "CREATE USER IF NOT EXISTS demo;" || true
    fi

    ${COCKROACH_BIN} sql --insecure --host=${INIT_HOST} --execute "GRANT ALL ON DATABASE movr TO demo;" || true
    echo "Init script completed."
    exit 0

