# GENERATED â€” review before use
# HAProxy configuration for CockroachDB cluster.
# Security rationale:
# - TCP frontend used for SQL traffic to avoid HTTP parsing and preserve transparency.
# - HTTP frontend used for CockroachDB Admin UI.
# - This config is for local development only and does not provide TLS or access control.
# TODO: add TLS/mTLS for production; restrict bind addresses; add basic auth or IP allowlist.

global
    log stdout format raw local0
    maxconn 4096

defaults
    log global
    mode tcp
    option tcplog
    timeout connect 5s
    timeout client 1m
    timeout server 1m

# SQL (TCP) frontend: exposes a single endpoint that load-balances SQL traffic across nodes.
frontend cockroach_sql
    bind *:26257
    mode tcp
    default_backend cockroach_sql_backend

backend cockroach_sql_backend
    mode tcp
    option tcp-check
    # Each server entry points at the internal Docker service name and Cockroach SQL port.
    server cockroach1 cockroach1:26257 check
    server cockroach2 cockroach2:26257 check
    server cockroach3 cockroach3:26257 check

# HTTP admin UI: proxies the admin UI on port 8080.
frontend cockroach_http
    bind *:8080
    mode http
    default_backend cockroach_http_backend

backend cockroach_http_backend
    mode http
    # Basic HTTP health check -- adjust the path if your CockroachDB admin UI exposes a different health endpoint.
    option httpchk GET /
    http-check expect status 200 301 302
    server cockroach1_http cockroach1:8080 check
    server cockroach2_http cockroach2:8080 check
    server cockroach3_http cockroach3:8080 check

# Notes:
# - For secure setups, terminate TLS at the proxy and use --certs-dir on the cockroach nodes, or use TCP passthrough + node certs.
# - Consider adding an allowlist for source IPs and authentication for the admin UI in non-dev environments.
# - TODO: add stats socket or admin page for haproxy and restrict its access.
