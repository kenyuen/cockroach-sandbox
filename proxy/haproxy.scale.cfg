# GENERATED â€” review before use
# HAProxy config exposing CockroachDB SQL + Admin UI for the scaled cluster experiment.
# Security rationale: single-entrypoint proxy limits open host ports to 26257/8080 while keeping nodes internal.
# TODO: add TLS/mTLS, bind controls, and stricter auth for non-dev workloads.

global
    log stdout format raw local0
    maxconn 4096

defaults
    log global
    mode tcp
    option tcplog
    timeout connect 5s
    timeout client 1m
    timeout server 1m

# SQL (TCP) frontend
frontend cockroach_sql
    bind *:26257
    mode tcp
    default_backend cockroach_sql_backend

backend cockroach_sql_backend
    mode tcp
    balance roundrobin
    option tcp-check
    # Compose names scaled replicas as cockroach_<n>, so list the expected range here.
    # TODO: keep the number of entries in sync with `--scale` (or migrate to dynamic discovery later).
    server-template cockroach 5 cockroach:26257 check

# HTTP admin frontend
frontend cockroach_http
    bind *:8080
    mode http
    default_backend cockroach_http_backend

backend cockroach_http_backend
    mode http
    option httpchk GET /
    http-check expect status 200
    server-template cockroach_http 5 cockroach:8080 check

# Notes: the HAProxy container runs on the same network as Cockroach so it can reach cockroach_<n> names.
