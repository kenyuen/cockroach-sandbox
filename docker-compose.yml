# GENERATED â€” review before use
# Docker Compose for a 6-node CockroachDB local cluster split across East/West regions.
# Security rationale: running in --insecure mode for local dev only. TODO: add TLS/certs for secure mode and region-aware certs.


services:
  cockroach1:
    image: "${COCKROACH_IMAGE}:${COCKROACH_TAG}"
    container_name: cockroach1
    # Region: East (datacenter dc1). TODO: sync locality labels with production metadata.
    # Command list prevents flag-parsing ambiguity in Docker Compose.
    command:
      - start
      - --insecure
      - --join=${JOIN_HOSTS}
      - --listen-addr=cockroach1:26257
      - --http-addr=cockroach1:8080
      - --advertise-addr=cockroach1:26257
      - --locality=region=east,datacenter=dc1
    hostname: cockroach1
    volumes:
      - "/cockroach/cockroach-data"
    restart: ${RESTART_POLICY:-"no"}
    healthcheck:
      test: ["CMD", "/cockroach/cockroach", "node", "status", "--insecure", "--host=localhost:26257"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - cockroach_net

  cockroach2:
    image: "${COCKROACH_IMAGE}:${COCKROACH_TAG}"
    container_name: cockroach2
    # Region: East (datacenter dc2). TODO: align datacenter metadata with Prod.
    command:
      - start
      - --insecure
      - --join=${JOIN_HOSTS}
      - --listen-addr=cockroach2:26257
      - --http-addr=cockroach2:8080
      - --advertise-addr=cockroach2:26257
      - --locality=region=east,datacenter=dc2
    hostname: cockroach2
    volumes:
      - "/cockroach/cockroach-data"
    restart: ${RESTART_POLICY:-"no"}
    healthcheck:
      test: ["CMD", "/cockroach/cockroach", "node", "status", "--insecure", "--host=localhost:26257"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - cockroach_net

  cockroach3:
    image: "${COCKROACH_IMAGE}:${COCKROACH_TAG}"
    container_name: cockroach3
    # Region: East (datacenter dc3). TODO: add TLS/cert for east-locality endpoints.
    command:
      - start
      - --insecure
      - --join=${JOIN_HOSTS}
      - --listen-addr=cockroach3:26257
      - --http-addr=cockroach3:8080
      - --advertise-addr=cockroach3:26257
      - --locality=region=east,datacenter=dc3
    hostname: cockroach3
    volumes:
      - "/cockroach/cockroach-data"
    restart: ${RESTART_POLICY:-"no"}
    healthcheck:
      test: ["CMD", "/cockroach/cockroach", "node", "status", "--insecure", "--host=localhost:26257"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - cockroach_net

  cockroach4:
    image: "${COCKROACH_IMAGE}:${COCKROACH_TAG}"
    container_name: cockroach4
    # Region: West (datacenter dc4). TODO: ensure west nodes mirror east-locality failover config.
    command:
      - start
      - --insecure
      - --join=${JOIN_HOSTS}
      - --listen-addr=cockroach4:26257
      - --http-addr=cockroach4:8080
      - --advertise-addr=cockroach4:26257
      - --locality=region=west,datacenter=dc4
    hostname: cockroach4
    volumes:
      - "/cockroach/cockroach-data"
    restart: ${RESTART_POLICY:-"no"}
    healthcheck:
      test: ["CMD", "/cockroach/cockroach", "node", "status", "--insecure", "--host=localhost:26257"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - cockroach_net

  cockroach5:
    image: "${COCKROACH_IMAGE}:${COCKROACH_TAG}"
    container_name: cockroach5
    # Region: West (datacenter dc5). TODO: add west-region observability tags.
    command:
      - start
      - --insecure
      - --join=${JOIN_HOSTS}
      - --listen-addr=cockroach5:26257
      - --http-addr=cockroach5:8080
      - --advertise-addr=cockroach5:26257
      - --locality=region=west,datacenter=dc5
    hostname: cockroach5
    volumes:
      - "/cockroach/cockroach-data"
    restart: ${RESTART_POLICY:-"no"}
    healthcheck:
      test: ["CMD", "/cockroach/cockroach", "node", "status", "--insecure", "--host=localhost:26257"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - cockroach_net

  cockroach6:
    image: "${COCKROACH_IMAGE}:${COCKROACH_TAG}"
    container_name: cockroach6
    # Region: West (datacenter dc6). TODO: map west datacenters to monitoring dashboards.
    command:
      - start
      - --insecure
      - --join=${JOIN_HOSTS}
      - --listen-addr=cockroach6:26257
      - --http-addr=cockroach6:8080
      - --advertise-addr=cockroach6:26257
      - --locality=region=west,datacenter=dc6
    hostname: cockroach6
    volumes:
      - "/cockroach/cockroach-data"
    restart: ${RESTART_POLICY:-"no"}
    healthcheck:
      test: ["CMD", "/cockroach/cockroach", "node", "status", "--insecure", "--host=localhost:26257"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - cockroach_net

  init:
    image: "${COCKROACH_IMAGE}:${COCKROACH_TAG}"
    container_name: cockroach-init
    depends_on:
      - cockroach1
      - cockroach2
      - cockroach3
      - cockroach4
      - cockroach5
      - cockroach6
    entrypoint: ["/bin/bash", "/init/init-cockroach.sh"]
    volumes:
      - ./init:/init:ro
    environment:
      - INIT_HOST=${INIT_HOST}
    restart: "no"
    networks:
      - cockroach_net

  proxy:
    image: haproxy:2.9
    container_name: cockroach-proxy
    depends_on:
      - cockroach1
      - cockroach2
      - cockroach3
      - cockroach4
      - cockroach5
      - cockroach6
    volumes:
      - ./proxy/haproxy.cfg:/usr/local/etc/haproxy/haproxy.cfg:ro
    ports:
      - "${PROXY_SQL_PORT:-26257}:26257"  # Expose a single SQL port for clients
      - "${PROXY_HTTP_PORT:-8080}:8080"    # Admin UI
    restart: ${RESTART_POLICY:-"no"}
    healthcheck:
      test: ["CMD", "haproxy", "-c", "-f", "/usr/local/etc/haproxy/haproxy.cfg"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s
    networks:
      - cockroach_net

# Explicit named volumes for node data. Using explicit names avoids interpolation in top-level keys.
volumes:
  cockroach-data-1:
  cockroach-data-2:
  cockroach-data-3:
  cockroach-data-4:
  cockroach-data-5:
  cockroach-data-6:

# Explicit network following modern Compose specification (v2+ / Compose spec).
networks:
  cockroach_net:
    driver: bridge

# Notes:
# - This compose file expects a .env (or pass env vars via --env-file) with variables described in .env.sample.
# - For secure setups, replace --insecure with --certs-dir and mount a certs directory into each node. TODO: add per-region cert secrets.
# - Healthchecks use the cockroach binary at /cockroach/cockroach inside the official image.
# - If you prefer a different naming scheme for volumes, use explicit names (no ${VAR} interpolation) in the top-level 'volumes:' block.
